
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Simulation Ascenseur - RÃ©seau de Petri</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <h1>Simulation Ascenseur â€“ RÃ©seau de Petri</h1>

    <div class="petri-net" id="petri-net">
        <div class="transition-buttons">
            <button onclick="fire('CallElevator')">ðŸšª Appeler l'ascenseur</button>
            <button onclick="fire('ArriveUp')">ðŸ›— Arriver Ã  l'Ã©tage</button>
            <button onclick="fire('CloseDoor')">ðŸšª Fermer la porte</button>
        </div>
    </div>

    <div class="status" id="status"></div>

    <script>
        let currentState = {{ state | tojson }};
        const transitions = [
            "CallElevator",
            "ArriveUp",
            "CloseDoor"
        ];

        async function isTransitionEnabled(transition) {
            const response = await fetch('/enabled', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({transition})
            });
            const data = await response.json();
            return data.enabled;
        }

        async function renderPetriNet() {
            const container = document.getElementById('petri-net');
            container.innerHTML = '';

            container.appendChild(createPlaceElement("Idle", currentState.Idle));

            const t0Enabled = await isTransitionEnabled("CallElevator");
            container.appendChild(createTransitionElement("CallElevator", t0Enabled));

            container.appendChild(createPlaceElement("MovingUp", currentState.MovingUp));

            const t1Enabled = await isTransitionEnabled("ArriveUp");
            container.appendChild(createTransitionElement("ArriveUp", t1Enabled));

            container.appendChild(createPlaceElement("DoorOpen", currentState.DoorOpen));

            const t2Enabled = await isTransitionEnabled("CloseDoor");
            container.appendChild(createTransitionElement("CloseDoor", t2Enabled));
        }

        function createPlaceElement(name, tokens) {
            const div = document.createElement('div');
            div.classList.add('place');
            if (tokens > 0) div.classList.add('active');

            const token = document.createElement('div');
            token.className = 'token-count';
            token.textContent = tokens;

            const label = document.createElement('div');
            label.className = 'place-label';
            label.textContent = name;

            div.appendChild(token);
            div.appendChild(label);
            return div;
        }

        function createTransitionElement(name, enabled) {
            const div = document.createElement('div');
            div.classList.add('transition');
            if (enabled) {
                div.classList.add('enabled');
                div.addEventListener('click', () => fire(name));
            }
            div.textContent = name;
            return div;
        }

        async function fire(transition) {
            const response = await fetch('/fire', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({transition})
            });
            const data = await response.json();
            document.getElementById('status').textContent = data.result;
            currentState = data.state;
            await renderPetriNet();
        }

        renderPetriNet();
    </script>
</body>
</html>
